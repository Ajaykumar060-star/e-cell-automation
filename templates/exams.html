{% extends "base.html" %}

{% block title %}Exams - Exam Management System{% endblock %}
{% block page_title %}Exam Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Exam Schedule</h5>
                    <button class="btn btn-primary" onclick="showAddExamModal()">
                        <i class="bi bi-plus-circle me-1"></i>Schedule Exam
                    </button>
                </div>
                <div class="card-body">
                    <!-- Search and Filter Section -->
                    <div class="row mb-3">
                        <div class="col-md-3 mb-2">
                            <input type="text" class="form-control" id="searchExamSubject"
                                placeholder="Search by subject">
                        </div>
                        <div class="col-md-3 mb-2">
                            <input type="date" class="form-control" id="searchExamDate">
                        </div>
                        <div class="col-md-3 mb-2">
                            <select class="form-select" id="filterExamDepartment">
                                <option value="">All Departments</option>
                                <!-- Departments will be populated dynamically -->
                            </select>
                        </div>
                        <div class="col-md-3 mb-2">
                            <select class="form-select" id="filterExamYear">
                                <option value="">All Years</option>
                                <option value="1st">1st Year</option>
                                <option value="2nd">2nd Year</option>
                                <option value="3rd">3rd Year</option>
                                <option value="4th">4th Year</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <button class="btn btn-outline-primary" onclick="applyExamFilters()">
                                <i class="bi bi-funnel me-1"></i>Apply Filters
                            </button>
                            <button class="btn btn-outline-secondary" onclick="resetExamFilters()">
                                <i class="bi bi-arrow-clockwise me-1"></i>Reset
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Subject</th>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Duration (min)</th>
                                    <th>Hall</th>
                                    <th>Staff</th>
                                    <th>Department</th>
                                    <th>Year</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="examsTableBody">
                                <!-- Exams will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Exam Modal -->
<div class="modal fade" id="examModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="examModalLabel">Schedule Exam</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="examForm">
                    <input type="hidden" id="examId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="examSubject" class="form-label">Subject</label>
                            <input type="text" class="form-control" id="examSubject" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="examDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="examDate" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="examTime" class="form-label">Time</label>
                            <input type="time" class="form-control" id="examTime" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="examDuration" class="form-label">Duration (minutes)</label>
                            <input type="number" class="form-control" id="examDuration" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="examHall" class="form-label">Hall</label>
                            <select class="form-select" id="examHall" required>
                                <option value="">Select Hall</option>
                                <!-- Halls will be loaded here -->
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="examRoomNumber" class="form-label">Room Number</label>
                            <input type="text" class="form-control" id="examRoomNumber" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="examStaff" class="form-label">Staff</label>
                            <select class="form-select" id="examStaff" required>
                                <option value="">Select Staff</option>
                                <!-- Staff will be loaded here -->
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="examDepartment" class="form-label">Department</label>
                            <input type="text" class="form-control" id="examDepartment" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="examYear" class="form-label">Year</label>
                            <input type="text" class="form-control" id="examYear" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveExam()">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
// Replace your entire scripts section with this code
<script>
    // Load exams when page loads
    document.addEventListener('DOMContentLoaded', function () {
        loadExams();
        loadHallsForSelect();
        loadStaffForSelect();
        loadExamFilters();
    });

    let allExams = []; // Store all exams for filtering

    function loadExams() {
        fetch('/api/exams')
            .then(response => response.json())
            .then(exams => {
                allExams = exams;
                // Filter out completed exams
                const activeExams = exams.filter(exam => exam.status !== 'completed');
                displayExams(activeExams);
                populateExamFilters(exams);
            })
            .catch(error => {
                console.error('Error loading exams:', error);
                showNotification('Error loading exams', 'danger');
            });
    }

    function displayExams(exams) {
        const tbody = document.getElementById('examsTableBody');
        tbody.innerHTML = '';

        if (exams.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="10" class="text-center">No exams scheduled</td>';
            tbody.appendChild(row);
            return;
        }

        exams.forEach(exam => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${exam.id}</td>
                <td>${exam.subject}</td>
                <td>${exam.date}</td>
                <td>${exam.time}</td>
                <td>${exam.duration}</td>
                <td>${exam.hall_name || 'N/A'}</td>
                <td>${exam.staff_name || 'N/A'}</td>
                <td>${exam.department}</td>
                <td>${exam.year}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editExam(${exam.id})">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteExam(${exam.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function loadHallsForSelect() {
        fetch('/api/halls')
            .then(response => response.json())
            .then(halls => {
                const select = document.getElementById('examHall');
                select.innerHTML = '<option value="">Select Hall</option>';

                halls.forEach(hall => {
                    const option = document.createElement('option');
                    option.value = hall.id;
                    // Include room number in the display text if available in facilities
                    const roomInfo = hall.facilities ? ` - ${hall.facilities}` : '';
                    option.textContent = `${hall.name} (Capacity: ${hall.capacity})${roomInfo}`;
                    select.appendChild(option);
                });
                
                // Add event listener for room number update
                select.addEventListener('change', updateRoomNumber);
            })
            .catch(error => {
                console.error('Error loading halls:', error);
                showNotification('Error loading halls', 'danger');
            });
    }

    function updateRoomNumber() {
        const hallId = document.getElementById('examHall').value;
        const roomNumberInput = document.getElementById('examRoomNumber');
        
        if (hallId) {
            // Get the selected hall details
            fetch(`/api/halls/${hallId}`)
                .then(response => response.json())
                .then(hall => {
                    // Use facilities as room number if available
                    if (hall.facilities) {
                        roomNumberInput.value = hall.facilities;
                    } else {
                        // Extract room number from hall name as fallback
                        const roomMatch = hall.name.match(/Room\s+(\w+)/i) || hall.name.match(/(\d+)/);
                        roomNumberInput.value = roomMatch ? roomMatch[1] : 'N/A';
                    }
                })
                .catch(error => {
                    console.error('Error loading hall details:', error);
                    roomNumberInput.value = 'N/A';
                });
        } else {
            roomNumberInput.value = '';
        }
    }

    function loadStaffForSelect() {
        fetch('/api/staff')
            .then(response => response.json())
            .then(staff => {
                const select = document.getElementById('examStaff');
                select.innerHTML = '<option value="">Select Staff</option>';

                staff.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = `${member.name} (${member.role})`;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading staff:', error);
                showNotification('Error loading staff', 'danger');
            });
    }

    function loadExamFilters() {
        fetch('/api/exams')
            .then(response => response.json())
            .then(exams => {
                populateExamFilters(exams);
            })
            .catch(error => {
                console.error('Error loading exam filters:', error);
            });
    }

    function populateExamFilters(exams) {
        // Populate department filter
        const departments = [...new Set(exams.map(exam => exam.department))];
        const deptSelect = document.getElementById('filterExamDepartment');

        // Clear existing options except the first one
        deptSelect.innerHTML = '<option value="">All Departments</option>';

        departments.forEach(dept => {
            if (dept) { // Only add if department is not empty
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                deptSelect.appendChild(option);
            }
        });
    }

    function applyExamFilters() {
        const subjectFilter = document.getElementById('searchExamSubject').value.toLowerCase();
        const dateFilter = document.getElementById('searchExamDate').value;
        const departmentFilter = document.getElementById('filterExamDepartment').value;
        const yearFilter = document.getElementById('filterExamYear').value;

        let filteredExams = allExams;

        if (subjectFilter) {
            filteredExams = filteredExams.filter(exam =>
                exam.subject && exam.subject.toLowerCase().includes(subjectFilter)
            );
        }

        if (dateFilter) {
            filteredExams = filteredExams.filter(exam =>
                exam.date === dateFilter
            );
        }

        if (departmentFilter) {
            filteredExams = filteredExams.filter(exam =>
                exam.department === departmentFilter
            );
        }

        if (yearFilter) {
            filteredExams = filteredExams.filter(exam =>
                exam.year === yearFilter
            );
        }

        displayExams(filteredExams);
    }

    function resetExamFilters() {
        document.getElementById('searchExamSubject').value = '';
        document.getElementById('searchExamDate').value = '';
        document.getElementById('filterExamDepartment').value = '';
        document.getElementById('filterExamYear').value = '';
        displayExams(allExams);
    }

    function showAddExamModal() {
        document.getElementById('examModalLabel').textContent = 'Schedule Exam';
        document.getElementById('examForm').reset();
        document.getElementById('examId').value = '';
        document.getElementById('examRoomNumber').value = '';

        // Reload dropdowns to ensure they have latest data
        loadHallsForSelect();
        loadStaffForSelect();

        const modal = new bootstrap.Modal(document.getElementById('examModal'));
        modal.show();
    }

    function editExam(id) {
        fetch(`/api/exams/${id}`)
            .then(response => response.json())
            .then(exam => {
                document.getElementById('examModalLabel').textContent = 'Edit Exam';
                document.getElementById('examId').value = exam.id;
                document.getElementById('examSubject').value = exam.subject;
                document.getElementById('examDate').value = exam.date;
                document.getElementById('examTime').value = exam.time;
                document.getElementById('examDuration').value = exam.duration;
                document.getElementById('examHall').value = exam.hall_id;
                document.getElementById('examStaff').value = exam.staff_id;
                document.getElementById('examDepartment').value = exam.department;
                document.getElementById('examYear').value = exam.year;

                // Set room number based on hall
                if (exam.hall_id) {
                    fetch(`/api/halls/${exam.hall_id}`)
                        .then(response => response.json())
                        .then(hall => {
                            if (hall.facilities) {
                                document.getElementById('examRoomNumber').value = hall.facilities;
                            }
                        })
                        .catch(error => {
                            console.error('Error loading hall details:', error);
                        });
                }

                const modal = new bootstrap.Modal(document.getElementById('examModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading exam:', error);
                showNotification('Error loading exam', 'danger');
            });
    }

    function saveExam() {
        const id = document.getElementById('examId').value;
        const examData = {
            subject: document.getElementById('examSubject').value,
            date: document.getElementById('examDate').value,
            time: document.getElementById('examTime').value,
            duration: parseInt(document.getElementById('examDuration').value),
            hall_id: parseInt(document.getElementById('examHall').value),
            staff_id: parseInt(document.getElementById('examStaff').value),
            department: document.getElementById('examDepartment').value,
            year: document.getElementById('examYear').value,
            status: 'upcoming' // Add status field
        };

        // Validate required fields
        if (!examData.subject || !examData.date || !examData.time || !examData.duration ||
            !examData.hall_id || !examData.staff_id || !examData.department || !examData.year) {
            showNotification('Please fill in all required fields', 'warning');
            return;
        }

        const url = id ? `/api/exams/${id}` : '/api/exams';
        const method = id ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(examData)
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                return response.json().then(err => { 
                    throw new Error(err.error || 'Failed to save exam'); 
                });
            }
        })
        .then(exam => {
            showNotification('Exam saved successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('examModal')).hide();
            loadExams(); // Reload the exams list
        })
        .catch(error => {
            console.error('Error saving exam:', error);
            showNotification(error.message || 'Error saving exam', 'danger');
        });
    }

    function deleteExam(id) {
        if (confirm('Are you sure you want to delete this exam? This will also delete all associated attendance records.')) {
            fetch(`/api/exams/${id}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    showNotification('Exam deleted successfully', 'success');
                    loadExams();
                } else {
                    throw new Error('Failed to delete exam');
                }
            })
            .catch(error => {
                console.error('Error deleting exam:', error);
                showNotification('Error deleting exam', 'danger');
            });
        }
    }

    // Helper function to show notifications
    function showNotification(message, type) {
        // Create a simple notification (you can replace this with a more sophisticated notification system)
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 3000);
    }
</script>
{% endblock %}